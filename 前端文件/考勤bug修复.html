<xform:editShow>
    <script>
        let orginalVacationTimeslot=0;

        // 请假类型值改变事件
        function selectTypeEvent(v,e){
            //切换了假期请假类型，则时间段差值初始化并设置为0
            var fdLeaveType= GetXFormFieldById("fdLeaveType")[0].value;
            //  获取假期额度
            var kmssData1 = new KMSSData();
            kmssData1.AddBeanData("kmReviewLeaveAmountByTypeService&fdLeaveType=" + fdLeaveType);
            var dataArray1 = kmssData1.GetHashMapArray();

            var days = 0;
            if (dataArray1 != null && dataArray1[0].days != null) {
                days = parseFloat(dataArray1[0].days);
            }
            GetXFormFieldById("fdOvtTime")[0].value = days;

            //  获取假期对应单位
            var kmssData2 = new KMSSData();
            kmssData2.AddBeanData("kmReviewStatTypeByTypeService&fdLeaveType=" + fdLeaveType);
            var dataArray2 = kmssData2.GetHashMapArray();

            var statType = '1';
            if (dataArray2 != null && dataArray2[0].statType!= null) {
                statType= dataArray2[0].statType;
            }

            // 设置计算天数/小时方式，默认按自然日计算
            // var fd_stat_day_type = "2";
            // if (dataArray2 != null && dataArray2[0].statDayType!= null) {
            // 	fd_stat_day_type = dataArray2[0].statDayType;
            // }
            // GetXFormFieldById("fd_stat_day_type ")[0].value = fd_stat_day_type ;

            var statTypeIndex = parseInt(statType) -1;
            console.info(statTypeIndex)
            if(statTypeIndex!=1){
                var gongshiTian2 = parseInt($("[name='extendDataFormInfo.value(fd_3d38f553fdc31c)").val());
                if (gongshiTian2>0)
                $("[name='extendDataFormInfo.value(fd_3c929324b4707e)']").val($("[name='extendDataFormInfo.value(fd_3d38f553fdc31c)").val());
            }else {
                var gongshiTian = parseInt($("[name='extendDataFormInfo.value(fd_3d38f553fdc31c)").val());
                var gongshiTian2=gongshiTian+ orginalVacationTimeslot;
                if (gongshiTian2>0)
                $("[name='extendDataFormInfo.value(fd_3c929324b4707e)']").val(gongshiTian2);
            }
            var statTypeRadio = $("[name='extendDataFormInfo.value(fdStatType)']");
            statTypeRadio.eq(statTypeIndex).prop("checked", true);
            statTypeRadio.eq(statTypeIndex).click();
            statTypeRadio.click(function() {
                return false;
            });

        }

        //添加提交校验，如果剩余假期时间小于请假天数那么不允许提交

        Com_Parameter.event["submit"].push(function() {
            debugger
            let canSubmit=true;
            var timeLeft = $("[name='extendDataFormInfo.value(fdOvtTime)']").val();
            var vacationDay = $("[name='extendDataFormInfo.value(fd_3c929324b4707e)']").val();
            var vacationHour = $("[name='extendDataFormInfo.value(fd_3cc6f3b29ba7bc)']").val();
            let fdLeaveType2= GetXFormFieldById("fdLeaveType")[0].value;

            $.ajax({
                url: '${LUI_ContextPath}/km/review/km_review_main/kmReviewMain.do?method=getVacationParams&fdLeaveType='+fdLeaveType2, // 请求的URL
                type: 'GET', // 请求类型为GET
                async:false,
                success: function(data) {
                    debugger
                    data=JSON.parse(data);
                    console.info("fdIsAmount",data.fdIsAmount);
                    console.info("fdSerialNo",data.fdSerialNo);
                    if (data.fdIsAmount) {
                        //开启了额度限制
                        if (timeLeft && vacationDay) {
                            //如果假期类型不是产假
                            if (data.fdSerialNo!=5) {
                                if (parseFloat(timeLeft) - parseFloat(vacationDay) < 0) {
                                    seajs.use(['lui/dialog'], function (dialog) {
                                        dialog.alert('剩余假期天数不足，请联系相关人调整剩余假期或者重新填写请假日期');
                                    })
                                    canSubmit=false;
                                } else {
                                    canSubmit=true;
                                }
                            }else {
                                //    如果假期类型是产假
                                let startTime = $("[name='extendDataFormInfo.value(fd_3c86992aed3590)']").val();
                                let endTime = $("[name='extendDataFormInfo.value(fd_3c8699465e843c)").val();
                                let diffTime = dateDiff(startTime,endTime);
                                if (parseInt(timeLeft) - parseInt(diffTime) < 0) {
                                    seajs.use(['lui/dialog'], function (dialog) {
                                        dialog.alert('剩余假期天数不足，请联系相关人调整剩余假期或者重新填写请假日期');
                                    })
                                    canSubmit=false;
                                } else {
                                    canSubmit=true;
                                }

                            }
                        } else {
                            if (parseFloat(timeLeft) * 8 - parseFloat(vacationHour) < 0) {
                                seajs.use(['lui/dialog'], function (dialog) {
                                    dialog.alert('剩余假期小时不足，请联系相关人调整剩余假期或者重新填写请假日期时间');
                                })
                                canSubmit=false;
                            } else {
                                canSubmit=true;
                            }
                        }

                    }
                }
            });


        return canSubmit;
        });


        function dateDiff(date1, date2) {
            // 解析日期字符串为Date对象
            var d1 = new Date(date1);
            var d2 = new Date(date2);

            // 计算两个日期之间的时间差（以毫秒为单位）
            var timeDiff = Math.abs(d1.getTime() - d2.getTime());
            if(d2.getTime()-d1.getTime()<0){
                seajs.use(['lui/dialog'], function (dialog) {
                    dialog.alert('结束时间小于开始时间，请重新输入结束时间或者开始时间');
                })
                return;
            }


            // 将时间差转换为天数
            var diffDays = Math.ceil((timeDiff / (1000 * 3600 * 24))+1);

            return diffDays;
        }
        //时间段控件值监听事件
        function endAndStartTimeChangeEvent(){
            debugger
            if (!GetXFormFieldById("fdLeaveType")[0].value){
                    seajs.use(['lui/dialog'], function (dialog) {
                        dialog.alert('请先选择假期类型');
                    })
                    return;
            }
            let startTime = $("[name='extendDataFormInfo.value(fd_3c86992aed3590)']").val();
            if (!startTime){
                seajs.use(['lui/dialog'], function (dialog) {
                    dialog.alert('请先选择开始时间');
                })
                return;
            }
            let origialVacatonDay=parseInt(GetXFormFieldById("fd_3d38f553fdc31c")[0].value);
            origialVacatonDay=origialVacatonDay+orginalVacationTimeslot;
            let fdLeaveType3= GetXFormFieldById("fdLeaveType")[0].value;
            if (fdLeaveType3==5 || fdLeaveType3==6 || fdLeaveType3==10){
                let endTime = $("[name='extendDataFormInfo.value(fd_3c8699465e843c)").val();
                let diffTime = dateDiff(startTime,endTime);
                origialVacatonDay=diffTime+orginalVacationTimeslot;
            }
            if (origialVacatonDay>0)
            $("[name='extendDataFormInfo.value(fd_3c929324b4707e)']").val(origialVacatonDay);
        }
        function timePartChangeEvent(){
            debugger
            //初始化时长（天）控件的值
            // let shichangTian=origialVacatonDay;
            let shichangTian=parseInt(GetXFormFieldById("fd_3d38f553fdc31c")[0].value);
            let startTimePart = parseInt(GetXFormFieldById("fd_3c86992e4fbb48")[0].value);
            let endTimePart = parseInt(GetXFormFieldById("fd_3c86995230882a")[0].value);
            // let startTime = $("[name='extendDataFormInfo.value(fd_3c86992aed3590)']").val();
            // let endTime = $("[name='extendDataFormInfo.value(fd_3c8699465e843c)").val();
            // if (!(startTime && endTimePart)){
            //     seajs.use(['lui/dialog'], function (dialog) {
            //         dialog.alert('请先选择开始时间和结束时间');
            //     })
            //     return;
            // }

            if (startTimePart-endTimePart==0){
                orginalVacationTimeslot=-0.5;
                shichangTian=shichangTian+orginalVacationTimeslot;
            }else if (startTimePart>endTimePart){
                orginalVacationTimeslot=-1;
                shichangTian=shichangTian+orginalVacationTimeslot;
            }else {
                orginalVacationTimeslot=0;
                shichangTian=shichangTian+orginalVacationTimeslot;
            }
            if (shichangTian>0)
            $("[name='extendDataFormInfo.value(fd_3c929324b4707e)']").val(shichangTian);




        }
            AttachXFormValueChangeEventById("fd_3c86992e4fbb48", timePartChangeEvent);
            AttachXFormValueChangeEventById("fd_3c86995230882a", timePartChangeEvent);

        AttachXFormValueChangeEventById("fd_3c86992aed3590", endAndStartTimeChangeEvent);
        AttachXFormValueChangeEventById("fd_3c8699465e843c", endAndStartTimeChangeEvent);
        document.addEventListener("DOMContentLoaded", function() {
            // DOM 已经完全加载和解析，但其他资源可能还没有加载完
            $("[name='extendDataFormInfo.value(fd_3d38f553fdc31c)']").hide()
        });






        AttachXFormValueChangeEventById("fdLeaveType", selectTypeEvent);
    </script>
</xform:editShow>
